//
//  ImageShareHelper.swift
//  SpeedType
//
//  Created by Assistant on 2024.
//

import AppKit
import SwiftUI
import UserNotifications

class ImageShareHelper {
  /// ç”Ÿæˆå¸¦æ°´å°çš„ç»“æœå›¾ç‰‡
  static func generateResultImage(testState: TypingTestState) -> NSImage? {
    let width: CGFloat = 600
    let height: CGFloat = 400

    let image = NSImage(size: NSSize(width: width, height: height))

    image.lockFocus()

    // èƒŒæ™¯
    NSColor.windowBackgroundColor.setFill()
    NSRect(x: 0, y: 0, width: width, height: height).fill()

    // ç»˜åˆ¶å†…å®¹
    drawResultContent(testState: testState, in: NSRect(x: 0, y: 0, width: width, height: height))

    image.unlockFocus()

    return image
  }

  /// ç»˜åˆ¶ç»“æœå†…å®¹
  private static func drawResultContent(testState: TypingTestState, in rect: NSRect) {
    let padding: CGFloat = 40
    let contentRect = NSRect(
      x: padding,
      y: padding,
      width: rect.width - 2 * padding,
      height: rect.height - 2 * padding
    )

    // æ ‡é¢˜
    let titleAttributes: [NSAttributedString.Key: Any] = [
      .font: NSFont.systemFont(ofSize: 28, weight: .bold),
      .foregroundColor: NSColor.labelColor,
    ]

    let title = "SpeedType æµ‹è¯•ç»“æœ"
    let titleSize = title.size(withAttributes: titleAttributes)
    let titleRect = NSRect(
      x: contentRect.midX - titleSize.width / 2,
      y: contentRect.maxY - titleSize.height - 20,
      width: titleSize.width,
      height: titleSize.height
    )
    title.draw(in: titleRect, withAttributes: titleAttributes)

    // ä¸»è¦æŒ‡æ ‡
    let metricsY = titleRect.minY - 60
    drawMetric(
      icon: "âš¡",
      value: String(format: "%.1f", testState.wpm),
      label: "WPM",
      at: NSPoint(x: contentRect.minX + 50, y: metricsY)
    )

    drawMetric(
      icon: "ğŸ¯",
      value: "\(testState.accuracy)%",
      label: "å‡†ç¡®ç‡",
      at: NSPoint(x: contentRect.midX - 50, y: metricsY)
    )

    // æ¬¡è¦æŒ‡æ ‡
    let secondaryY = metricsY - 80
    drawMetric(
      icon: "ğŸ“",
      value: "\(testState.currentIndex)",
      label: "å­—ç¬¦",
      at: NSPoint(x: contentRect.minX + 50, y: secondaryY)
    )

    drawMetric(
      icon: "â±ï¸",
      value: String(format: "%.2f", testState.elapsedTime),
      label: "æ—¶é—´",
      at: NSPoint(x: contentRect.midX - 50, y: secondaryY)
    )

    // æ°´å°
    let watermarkAttributes: [NSAttributedString.Key: Any] = [
      .font: NSFont.systemFont(ofSize: 14, weight: .medium),
      .foregroundColor: NSColor.secondaryLabelColor,
    ]

    let watermark = "Generated by SpeedType"
    let watermarkSize = watermark.size(withAttributes: watermarkAttributes)
    let watermarkRect = NSRect(
      x: contentRect.maxX - watermarkSize.width,
      y: contentRect.minY,
      width: watermarkSize.width,
      height: watermarkSize.height
    )
    watermark.draw(in: watermarkRect, withAttributes: watermarkAttributes)
  }

  /// ç»˜åˆ¶å•ä¸ªæŒ‡æ ‡
  private static func drawMetric(icon: String, value: String, label: String, at point: NSPoint) {
    let iconAttributes: [NSAttributedString.Key: Any] = [
      .font: NSFont.systemFont(ofSize: 24),
      .foregroundColor: NSColor.labelColor,
    ]

    let valueAttributes: [NSAttributedString.Key: Any] = [
      .font: NSFont.systemFont(ofSize: 32, weight: .bold),
      .foregroundColor: NSColor.labelColor,
    ]

    let labelAttributes: [NSAttributedString.Key: Any] = [
      .font: NSFont.systemFont(ofSize: 14, weight: .medium),
      .foregroundColor: NSColor.secondaryLabelColor,
    ]

    // å›¾æ ‡
    let iconSize = icon.size(withAttributes: iconAttributes)
    icon.draw(at: NSPoint(x: point.x, y: point.y + 40), withAttributes: iconAttributes)

    // æ•°å€¼
    let valueSize = value.size(withAttributes: valueAttributes)
    value.draw(
      at: NSPoint(x: point.x + iconSize.width + 10, y: point.y + 35),
      withAttributes: valueAttributes
    )

    // æ ‡ç­¾
    label.draw(
      at: NSPoint(x: point.x + iconSize.width + 10, y: point.y + 10),
      withAttributes: labelAttributes
    )
  }

  /// åˆ†äº«å›¾ç‰‡
  static func shareImage(_ image: NSImage) {
    // è½¬æ¢ä¸ºPNGæ•°æ®
    guard let tiffData = image.tiffRepresentation,
          let bitmapRep = NSBitmapImageRep(data: tiffData),
          let pngData = bitmapRep.representation(using: .png, properties: [:])
    else {
      return
    }

    // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
    let tempURL = FileManager.default.temporaryDirectory
      .appendingPathComponent("SpeedType_Result_\(Date().timeIntervalSince1970).png")

    do {
      try pngData.write(to: tempURL)

      // å°è¯•å¤šç§åˆ†äº«æ–¹å¼
      if shareViaSystemService(url: tempURL) {
        return
      }

      if shareViaFinder(url: tempURL) {
        return
      }

      shareViaClipboard(data: pngData)

    } catch {
      // ç›´æ¥å¤åˆ¶åˆ°å‰ªè´´æ¿
      shareViaClipboard(data: pngData)
    }
  }

  /// é€šè¿‡ç³»ç»Ÿåˆ†äº«æœåŠ¡åˆ†äº«
  private static func shareViaSystemService(url: URL) -> Bool {
    if #available(macOS 13.0, *) {
      // ä½¿ç”¨æ–°çš„API - åˆ›å»ºåˆ†äº«é€‰æ‹©å™¨
      let picker = NSSharingServicePicker(items: [url])
      let shareMenuItem = picker.standardShareMenuItem

      // åœ¨ä¸»çº¿ç¨‹ä¸Šæ˜¾ç¤ºåˆ†äº«èœå•
      DispatchQueue.main.async {
        if let window = NSApplication.shared.keyWindow {
          let event = NSApplication.shared.currentEvent
          let location =
            event?.locationInWindow
              ?? NSPoint(x: window.frame.width / 2, y: window.frame.height / 2)

          // åˆ›å»ºä¸´æ—¶èœå•æ¥æ˜¾ç¤ºåˆ†äº«é€‰é¡¹
          let menu = NSMenu()
          menu.addItem(shareMenuItem)
          menu.popUp(positioning: shareMenuItem, at: location, in: window.contentView)
        }
      }
      return true
    } else {
      // å…¼å®¹æ—§ç‰ˆæœ¬macOS
      let sharingServices = NSSharingService.sharingServices(forItems: [url])

      if let firstService = sharingServices.first {
        firstService.perform(withItems: [url])
        return true
      }

      return false
    }
  }

  /// é€šè¿‡Finderæ˜¾ç¤ºæ–‡ä»¶
  private static func shareViaFinder(url: URL) -> Bool {
    NSWorkspace.shared.selectFile(
      url.path, inFileViewerRootedAtPath: url.deletingLastPathComponent().path
    )
    return true
  }

  /// å¤åˆ¶åˆ°å‰ªè´´æ¿
  private static func shareViaClipboard(data: Data) {
    let pasteboard = NSPasteboard.general
    pasteboard.clearContents()
    pasteboard.setData(data, forType: .png)

    // ä½¿ç”¨ç°ä»£çš„UserNotificationsæ¡†æ¶
    if #available(macOS 10.14, *) {
      let center = UNUserNotificationCenter.current()

      let content = UNMutableNotificationContent()
      content.title = "SpeedType"
      content.body = "æµ‹è¯•ç»“æœå›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
      content.sound = UNNotificationSound.default

      let request = UNNotificationRequest(
        identifier: "speedtype_share", content: content, trigger: nil
      )
      center.add(request) { _ in
        // å¿½ç•¥é€šçŸ¥é”™è¯¯
      }
    }
  }
}
